-- =============================================
-- Author:		Raúl Reyes Muñoz
-- Create date: 2024-01-01
-- Description:	This trigger is used to update all warehouses when the user move some value in the dbFinishing tblTestResults records.
--				This is because when is modified TestCategory value dosen't change the value since the tblRulos value is changed before modifying tblTestResults
-- =============================================
CREATE TRIGGER trgUpdateWarehouseTestResult
   ON tblTestResults
   AFTER UPDATE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @testCategory int
	
	SET @testCategory = (SELECT TOP 1 TC.TestCategoryID FROM inserted TR
						INNER JOIN tblRulos R ON TR.TestResultID = R.TestResultID
						INNER JOIN tblTestCategories TC ON TR.TestCategoryID = TC.TestCategoryID
						)

	--CASE 4 AND CASE 5
	IF (@testCategory = 9)
		BEGIN
			UPDATE tblRulos	SET WarehouseCategoryID = 3 WHERE RuloID = (SELECT TOP 1 R.RuloID FROM inserted TR
								INNER JOIN tblRulos R ON TR.TestResultID = R.TestResultID
								INNER JOIN tblTestCategories TC ON TR.TestCategoryID = TC.TestCategoryID
								WHERE R.IsDeleted <> 1 AND TC.TestCategoryID IN (@testCategory) AND (select COUNT(*) from dbInspeqtorNew..tblParti where Durum=1 and Ek26P = R.RuloID) = 0)
		END
	ELSE IF (@testCategory = 6)
		BEGIN
			UPDATE tblRulos	SET WarehouseCategoryID = 4 WHERE RuloID = (SELECT TOP 1 R.RuloID FROM inserted TR
								INNER JOIN tblRulos R ON TR.TestResultID = R.TestResultID
								INNER JOIN tblTestCategories TC ON TR.TestCategoryID = TC.TestCategoryID
								WHERE R.IsDeleted <> 1 AND TC.TestCategoryID IN (@testCategory) AND (select COUNT(*) from dbInspeqtorNew..tblParti where Durum=1 and Ek26P = R.RuloID) = 0)
		END
	ELSE IF (@testCategory = 3 OR @testCategory = 4)
		BEGIN
			UPDATE tblRulos	SET WarehouseCategoryID = 5 WHERE RuloID = (SELECT TOP 1 R.RuloID FROM inserted TR
								INNER JOIN tblRulos R ON TR.TestResultID = R.TestResultID
								INNER JOIN tblTestCategories TC ON TR.TestCategoryID = TC.TestCategoryID
								WHERE R.IsDeleted <> 1 AND TC.TestCategoryID IN (3,4) AND (select COUNT(*) from dbInspeqtorNew..tblParti where Durum=1 and Ek26P = R.RuloID) = 0)
		END

END
GO